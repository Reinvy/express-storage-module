# Express Storage Module

[![Node.js Version](https://img.shields.io/badge/node-%3E%3D14.0.0-brightgreen)](https://nodejs.org/)
[![Express.js](https://img.shields.io/badge/express-4.16.1-brightgreen)](https://expressjs.com/)
[![Prisma](https://img.shields.io/badge/prisma-5.22.0-blue)](https://www.prisma.io/)
[![MySQL](https://img.shields.io/badge/mysql-5.7%2B-blue)](https://www.mysql.com/)

A secure and scalable file storage service built with Express.js, Prisma ORM, and MySQL database. This module provides RESTful API endpoints for file upload, retrieval, update, and deletion with JWT authentication and IP whitelisting security features.

## 🚀 Features

- **File Management**: Upload, retrieve, update, and delete files with metadata
- **JWT Authentication**: Secure API access with JSON Web Tokens
- **IP Whitelisting**: Restrict API access to specific IP addresses
- **Multer Integration**: Handle multipart/form-data for file uploads
- **Prisma ORM**: Type-safe database operations with MySQL
- **Path Utilities**: Convert system paths to web-accessible URLs
- **Error Handling**: Comprehensive error handling and logging
- **File Size Limits**: Configurable file upload size limits (default: 20MB)

## 📋 Prerequisites

- Node.js 14.0 or higher
- MySQL 5.7 or higher
- npm or yarn package manager

## 🛠️ Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd express-storage-module
```

2. Install dependencies:
```bash
npm install
```

3. Set up environment variables:
```bash
cp .env.example .env
```

4. Configure your `.env` file (see [Environment Configuration](#environment-configuration))

5. Set up the database:
```bash
# Generate Prisma client
npx prisma generate

# Run database migrations
npx prisma migrate dev --name init

# (Optional) Seed the database with initial data
npx prisma db seed
```

## ⚙️ Environment Configuration

Create a `.env` file based on `.env.example`:

```env
# ========================
# Application & Server Config
# ========================

# Port where the application runs
PORT=3000

# Secret for JWT (JSON Web Token)
# Replace with a stronger secret value in production
# IMPORTANT: This secret MUST match the secret used by the external application that generates JWT tokens
JWT_SECRET=inirahasia

# ========================
# Security Config
# ========================

# List of IPs allowed to access the application.
# Separate with commas.
# ::1 is IPv6 loopback (equivalent to 127.0.0.1).
# Comment this line to allow all IPs.
WHITELIST_IPS=1.2.3.4,10.0.0.2,127.0.0.1,::1

# ========================
# Database Config
# ========================

# Database connection URL.
# General format:
# DATABASE_URL="mysql://USER:PASSWORD@HOST:PORT/DATABASE_NAME"
DATABASE_URL="mysql://root:root@localhost:3306/db_storage"

# ========================
# Prisma Config
# ========================

# Variables in this file are automatically read by Prisma.
# Documentation: https://pris.ly/d/prisma-schema#accessing-environment-variables-from-the-schema
```

## 🗄️ Database Schema

The application uses a single `File` model with the following structure:

```prisma
model File {
  id         String   @id @default(uuid())
  name       String   // File name
  path       String   // File path or URL
  size       Int      // File size in bytes
  mimeType   String   // File MIME type
  uploadedAt DateTime @default(now()) // Upload timestamp
  userId     String?  // Optional reference to other entities
}
```

## 📡 API Endpoints

All storage endpoints require JWT authentication and are prefixed with `/api/v1/storages`.

### Authentication

This is a **JWT-consuming service**, not a JWT-issuing service. It does not handle user login, user management, or JWT token generation. JWT tokens must be generated by external applications or authentication modules and passed to this storage module.

**JWT Token Requirements:**
- JWT tokens must be generated by an external authentication system
- Include the JWT token in the `Authorization` header as a Bearer token:
```
Authorization: Bearer <your-jwt-token>
```
- The `JWT_SECRET` in your `.env` file **must match** the secret used by the application that generates the tokens
- This storage module must be used alongside a separate authentication system

### Storage Endpoints

#### Get All Files
```http
GET /api/v1/storages/
```

**Response:**
```json
{
  "success": true,
  "message": "Files found successfully",
  "data": [
    {
      "id": "uuid-1",
      "name": "example.jpg",
      "path": "/uploads/example.jpg",
      "size": 1024000,
      "mimeType": "image/jpeg",
      "uploadedAt": "2024-01-01T00:00:00.000Z",
      "userId": "user123"
    }
  ]
}
```

#### Get File by ID
```http
GET /api/v1/storages/:id
```

**Parameters:**
- `id` (string, required): UUID of the file

**Response:**
```json
{
  "status": "success",
  "message": "File found successfully",
  "data": {
    "id": "uuid-1",
    "name": "example.jpg",
    "path": "/uploads/example.jpg",
    "size": 1024000,
    "mimeType": "image/jpeg",
    "uploadedAt": "2024-01-01T00:00:00.000Z",
    "userId": "user123"
  }
}
```

#### Upload File
```http
POST /api/v1/storages/
```

**Headers:**
```
Content-Type: multipart/form-data
Authorization: Bearer <your-jwt-token>
```

**Body:**
- `file` (file, required): File to upload

**Response:**
```json
{
  "success": true,
  "message": "File uploaded successfully",
  "data": {
    "id": "uuid-1",
    "name": "example.jpg",
    "path": "/uploads/example.jpg",
    "size": 1024000,
    "mimeType": "image/jpeg",
    "url": "/uploads/example.jpg"
  }
}
```

#### Update File
```http
PUT /api/v1/storages/:id
```

**Parameters:**
- `id` (string, required): UUID of the file to update

**Headers:**
```
Content-Type: multipart/form-data
Authorization: Bearer <your-jwt-token>
```

**Body:**
- `file` (file, required): New file to upload

**Response:**
```json
{
  "success": true,
  "message": "File updated successfully"
}
```

#### Delete File
```http
DELETE /api/v1/storages/:id
```

**Parameters:**
- `id` (string, required): UUID of the file to delete

**Headers:**
```
Authorization: Bearer <your-jwt-token>
```

**Response:**
```json
{
  "success": true,
  "message": "File deleted successfully"
}
```

## 📁 Project Structure

```
express-storage-module/
├── bin/
│   └── www                    # Server entry point
├── app/
│   ├── controllers/          # Request handlers
│   │   ├── getAll.js         # Get all files controller
│   │   ├── getById.js        # Get file by ID controller
│   │   ├── upload.js         # Upload file controller
│   │   ├── update.js         # Update file controller
│   │   └── destroy.js        # Delete file controller
│   ├── middlewares/          # Custom middleware
│   │   ├── verifyToken.js    # JWT verification middleware
│   │   ├── whitelist.js      # IP whitelisting middleware
│   │   └── multer.js         # File upload middleware
│   ├── routes/               # API routes
│   │   ├── index.js          # Main routes
│   │   └── storages.js       # Storage endpoints
│   ├── services/             # Business logic
│   │   ├── getAll.js         # Get all files service
│   │   ├── getById.js        # Get file by ID service
│   │   ├── upload.js         # Upload file service
│   │   ├── update.js         # Update file service
│   │   └── destroy.js        # Delete file service
│   └── utils/
│       └── pathUtils.js      # Path utility functions
├── prisma/
│   ├── migrations/           # Database migrations
│   └── schema.prisma         # Database schema
├── public/                   # Static files
│   ├── uploads/              # Uploaded files directory
│   ├── index.html            # Home page
│   └── stylesheets/
│       └── style.css         # CSS styles
├── .env.example              # Environment variables template
├── .gitignore                # Git ignore file
├── app.js                    # Express app configuration
├── package.json              # Project dependencies
├── package-lock.json         # Lock file
└── postman_collection.json   # Postman API collection
```

## 🔧 Dependencies

### Production Dependencies
- `@prisma/client` (^5.22.0) - Database ORM client
- `cookie-parser` (~1.4.4) - Parse cookie headers
- `debug` (~2.6.9) - Small debugging utility
- `dotenv` (^16.4.6) - Environment variables management
- `express` (~4.16.1) - Web framework for Node.js
- `jsonwebtoken` (^9.0.2) - JSON Web Token implementation
- `morgan` (~1.9.1) - HTTP request logger
- `multer` (^1.4.5-lts.1) - Middleware for handling multipart/form-data

### Development Dependencies
- `prisma` (^5.22.0) - Database toolkit

## 🚀 Development Scripts

```bash
# Start the application
npm start

# Start in development mode with auto-reload
npm run dev

# Generate Prisma client
npx prisma generate

# Create new database migration
npx prisma migrate dev --name <migration-name>

# Reset database (dangerous)
npx prisma migrate reset

# Open Prisma Studio
npx prisma studio
```

## 🧪 Testing

The project includes a Postman collection for API testing:

1. Import [`postman_collection.json`](postman_collection.json) into Postman
2. Set the `base_url` variable to your local server URL (e.g., `http://localhost:3000`)
3. Generate a JWT token and set it in the `jwt_token` variable
4. Run the collection tests

### Testing Endpoints

1. **Home Page**: Test basic server connectivity
2. **Storage Management**: Test all CRUD operations for files
3. **Authentication**: Example JWT token generation

### Testing Without Authentication Service

If you don't have an authentication service or module to generate JWT tokens, you can use online JWT generators for testing purposes. This method is only for development/testing and should not be used in production.

#### Step-by-Step Instructions

1. **Set JWT_SECRET in .env file**:
   ```bash
   # Open your .env file and set a secret
   JWT_SECRET=your-super-secret-key-here
   ```

2. **Use Online JWT Builder**:
   - Visit http://jwtbuilder.jamiekurtz.com/
   - Configure the JWT builder with the following settings:
     - **Algorithm**: HS256 (HMAC using SHA-256)
     - **Secret**: Use the same secret as your `JWT_SECRET` in `.env` file
     - **Payload**: Include user information like:
       ```json
       {
         "userId": "test-user-123",
         "email": "test@example.com",
         "iat": 1640995200,
         "exp": 1641004800
       }
       ```

3. **Generate and Copy Token**:
   - Click "Generate Token" button
   - Copy the generated JWT token (it will be in the format: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`)

4. **Use in API Requests**:
   - Include the generated token in your API requests as a Bearer token:
   ```
   Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

#### Example JWT Builder Configuration

```
Algorithm: HS256
Secret: your-super-secret-key-here

Payload:
{
  "userId": "test-user-123",
  "email": "test@example.com",
  "iat": 1640995200,
  "exp": 1641004800
}
```

**Important**: This method is only for development and testing purposes. In production, you should always use a proper authentication service that generates secure JWT tokens.

## 🔒 Security Features

### JWT Authentication
- All storage endpoints require valid JWT tokens
- Tokens must be included in the `Authorization` header
- Token verification is handled by [`verifyToken`](app/middlewares/verifyToken.js) middleware
- **Important**: This module only validates JWT tokens, it does not generate them

### IP Whitelisting
- Access can be restricted to specific IP addresses
- Configure `WHITELIST_IPS` in your `.env` file
- Supports both IPv4 and IPv6 addresses
- Empty whitelist allows all IPs (not recommended for production)

### File Upload Security
- File size limits (default: 20MB)
- Secure file storage in `public/uploads/` directory
- Automatic cleanup of failed uploads

## 📝 Usage Examples

### Basic File Upload

```javascript
const FormData = require('form-data');
const fs = require('fs');

// Note: JWT token must be generated by your external authentication system
const externalJwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

const form = new FormData();
form.append('file', fs.createReadStream('path/to/your/file.jpg'));

const response = await fetch('http://localhost:3000/api/v1/storages/', {
  method: 'POST',
  headers: {
    ...form.getHeaders(),
    'Authorization': `Bearer ${externalJwtToken}`
  },
  body: form
});

const result = await response.json();
console.log(result);
```

### Get All Files

```javascript
// Note: JWT token must be generated by your external authentication system
const externalJwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

const response = await fetch('http://localhost:3000/api/v1/storages/', {
  headers: {
    'Authorization': `Bearer ${externalJwtToken}`
  }
});

const result = await response.json();
console.log(result.data);
```

## 🐛 Troubleshooting

### Common Issues

1. **Database Connection Error**
   - Check your `DATABASE_URL` in `.env`
   - Ensure MySQL server is running
   - Verify database exists and user has permissions

2. **JWT Authentication Failed**
   - Check `JWT_SECRET` is set correctly
   - Ensure token is properly formatted: `Bearer <token>`
   - Verify token hasn't expired

3. **File Upload Issues**
   - Check file size limits in [`multer.js`](app/middlewares/multer.js)
   - Ensure `public/uploads/` directory exists and is writable
   - Verify file permissions

4. **IP Access Denied**
   - Check `WHITELIST_IPS` configuration
   - Verify your IP address is in the whitelist
   - Consider adding your development IP to the list

## 📄 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## 📞 Support

For support and questions:
- Create an issue in the GitHub repository
- Check the troubleshooting section above
- Review the API documentation

## 🔄 Changelog

### v0.0.0
- Initial release
- Basic file storage functionality
- JWT authentication
- IP whitelisting
- Prisma ORM integration
- Multer file upload handling

## 🔗 Integration Architecture

This storage module is designed to be a **standalone service** that integrates with external authentication systems. It does not handle user management or JWT token generation itself.

### System Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  Client App     │────▶│ Auth Service    │────▶│ Storage Module  │
│  (Web/Mobile)   │     │ (JWT Issuer)    │     │ (JWT Consumer)  │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │                 │
                       │   User Database │
                       │                 │
                       └─────────────────┘
```

### Integration Flow

1. **User Authentication**: Users authenticate with your main application or dedicated authentication service
2. **JWT Generation**: The authentication service generates a JWT token with user information
3. **Client Request**: Client applications include the JWT token in the `Authorization` header when making requests to the storage module
4. **Token Validation**: The storage module validates the JWT token using the shared `JWT_SECRET`
5. **File Operations**: Authorized users can perform file upload, retrieval, update, and delete operations

### Integration Requirements

- **Authentication Service**: You must provide a separate authentication service that generates JWT tokens
- **Shared Secret**: The `JWT_SECRET` in this module must match the secret used by your authentication service
- **Token Structure**: JWT tokens should contain sufficient user information for your application needs
- **Error Handling**: Implement proper error handling for invalid/expired tokens in your client applications

### Example Integration with Node.js

```javascript
// In your main application (auth service)
const jwt = require('jsonwebtoken');

// Generate JWT token
const token = jwt.sign(
  { userId: 'user123', email: 'user@example.com' },
  process.env.JWT_SECRET,
  { expiresIn: '1h' }
);

// In your client application
const storageApiUrl = 'http://localhost:3000/api/v1/storages';
const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

// Upload file to storage module
const response = await fetch(`${storageApiUrl}/`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'multipart/form-data'
  },
  body: formData
});
```

This modular approach allows you to:
- Use any authentication system (OAuth, JWT, custom auth)
- Scale the storage module independently
- Maintain separation of concerns
- Integrate with multiple client applications